<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Bakeoff 2 - Two Tap Square</title>
    <style type="text/css">
      /* Basic styling */
      body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      body.active {
        border-left: 3px #f06 solid;
      }
      footer {
        width: 100vw;
        text-align: center;
        position: absolute;
        bottom: 0;
        padding: 0.75em;
        border-top: 1px #ddd solid;
      }
      svg {
        border: 1px #ddd solid;
      }
    </style>
    <!-- Required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
    <script src="https://dhcs-s25-bakeoff2.glitch.me/framework.js"></script>
  </head>
  <body>
    <!-- SVG drawing area -->
    <div id="main"></div>
  </body>
  <script type="text/javascript">
    // =========== Required Bakeoff Setup ===========
    const tasksLength = 10;  // for the Bakeoff
    let svg = SVG().addTo('#main').size(""+canvasSize+"px", ""+canvasSize+"px");
    const judge = new Judge(tasksLength, svg, "teamName");
    // =========== End Required Setup ===========

    // Colors and styling:
    const targetStrokeColor = "#FFA500";
    const playerColor = "navy";
    const markerColor = "red";

    // Groups for player's square, target square, and corner markers.
    let manipulator = svg.group();
    let goalGroup = svg.group();
    let cornerMarkersGroup = svg.group();

    // -------------------------------
    // Two-tap mechanism globals:
    // -------------------------------
    // twoTapState: "waitingForFirst", "waitingForSecond", "done"
    let twoTapState = "waitingForFirst";
    let pointA = null, pointC = null;

    // -------------------------------
    // Mousemove handler (optional for visual feedback):
    // -------------------------------
    // Here you can update a temporary line if desired.
    // (Not required for two-tap version, so it’s omitted.)

    // -------------------------------
    // Click handler to record taps and add red corner markers.
    // -------------------------------
    svg.on("click", (e) => {
      // If a square was already finalized, then clear only the player's square.
      if (twoTapState === "done") {
        manipulator.clear();
        twoTapState = "waitingForFirst";
        pointA = pointC = null;
      }
      // Do not process clicks if all tasks are complete.
      if (judge.getTaskNumber() >= tasksLength) return;

      // Create a red marker (a small circle) at the tapped location.
      let marker = svg.circle(8).center(e.offsetX, e.offsetY).fill(markerColor);
      cornerMarkersGroup.add(marker);

      if (twoTapState === "waitingForFirst") {
        // First tap: record point A.
        pointA = { x: e.offsetX, y: e.offsetY };
        twoTapState = "waitingForSecond";
      } else if (twoTapState === "waitingForSecond") {
        // Second tap: record point C (diagonally opposite to point A).
        pointC = { x: e.offsetX, y: e.offsetY };
        finalizeSquare();
        cornerMarkersGroup.clear();
        twoTapState = "done";
      }
    });

    // -------------------------------
    // Function to finalize the square using points A and C.
    // -------------------------------
    function finalizeSquare() {
      // Compute the center of the square as the midpoint of A and C.
      let centerX = (pointA.x + pointC.x) / 2;
      let centerY = (pointA.y + pointC.y) / 2;
      // Compute the diagonal length.
      let diagLength = Math.hypot(pointC.x - pointA.x, pointC.y - pointA.y);
      // The side length is the diagonal divided by sqrt(2).
      let side = diagLength / Math.SQRT2;
      // Calculate the angle of the diagonal in degrees.
      let diagAngleDeg = Math.atan2(pointC.y - pointA.y, pointC.x - pointA.x) * 180 / Math.PI;
      // For a square, the rectangle rotation is the diagonal angle minus 45°.
      let squareAngle = diagAngleDeg - 45;
      // Create the player's square as a navy blue filled rectangle.
      let newSquare = svg.rect(side, side)
                         .center(centerX, centerY)
                         .rotate(squareAngle)
                         .fill(playerColor);
      // Ensure only one square exists: clear any previous square.
      manipulator.clear();
      manipulator.add(newSquare);
      // Assign the new square as the start square for the current task.
      let task = judge.getCurrentTask();
      task.start.square = newSquare;
    }

    judge.on("newTask", () => {
      let task = judge.getCurrentTask();
      // Style the target (goal) square with a thick orange stroke.
      task.goal.square.fill("none");
      task.goal.square.stroke({ color: targetStrokeColor, width: 4 });
      goalGroup.add(task.goal.square);
      // Remove any default start square.
      if (task.start.square) { task.start.square.remove(); }
      // Clear the manipulator group.
      manipulator.clear();
      // Clear corner markers from the previous task.
      cornerMarkersGroup.clear();
      // Reset the two-tap mechanism.
      twoTapState = "waitingForFirst";
      pointA = pointC = null;
    });

    judge.setup();
  </script>
</html>
